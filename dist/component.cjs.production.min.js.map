{"version":3,"file":"component.cjs.production.min.js","sources":["../src/errors.ts","../src/index.tsx"],"sourcesContent":["/*\n * In keeping with Elm, we'd like to have high quality error messages\n */\n\nconst libName = '@elm-react/component'\n\ntype Anchor\n  = 'install'\n  | 'usage'\n  | 'opts'\n  | 'complex-props'\n  | 'common-pitfalls'\n  | 'asset-size'\n  | 'with-elm-webpack-loader'\n  | 'with-cra'\n  | 'create-react-app'\n  | 'issues'\n\nfunction link (anchor?: Anchor) {\n  if (anchor === 'issues') {\n    return 'https://github.com/Parasrah/elm-react-component/issues'\n  }\n  if (anchor) {\n    return `https://github.com/Parasrah/elm-react-component#${anchor}`\n  }\n  return 'https://github.com/Parasrah/elm-react-component'\n}\n\n// we format these as javascript types, as it's more likely they are\n// familiar with js\nconst common = {\n  wrapDefinition: 'wrap(elm: ElmInstance, opts?: Options)',\n  missingOpt: 'It looks like some options are missing!',\n  expectedOpt: `We expected your opts to look like this:\n  {\n    path?: string[]\n  }`,\n  internalError (code: number) {\n    return `\n    ${libName} has experienced an internal error. please consider visiting\n    ${link('issues')} and opening an issue with the following format:\n\n    title: internal error: ${code}\n\n    description: <empty>\n    `\n  },\n}\n\nconst errors = {\n\n  missingRef: common.internalError(1),\n\n  duplicateInstance: common.internalError(2),\n\n  missingInstance: common.internalError(3),\n\n  missingPath: `\n  ${common.missingOpt}\n\n  ${common.expectedOpt}\n\n  \"path\" is only optional when you only have a single elm module. If you're seeing\n  this error, you've probably passed in more than one. You can figure out your path\n  by looking at the top of your elm module (file).\n\n  \\`module Elements.Button\\` translates to \\`path: ['Elements', 'Button']\\`\n\n  check out the readme for more information: ${link()}\n  `,\n\n  invalidElmInstance: `\n  \"wrap\" expects the following arguments:\n\n  ${common.wrapDefinition}\n\n  The provided Elm instance does not match what we expected. Maybe you passed in\n  arguments in the wrong order?\n\n  You can view ${link('usage')} for help\n  `,\n\n  invalidPath: `\n  The path provided to ${libName}#wrap could not be\n  resolved to an Elm module.\n\n  For more information, please read ${link('opts')}\n  `,\n\n  pathRequired: `\n  There seems to be multiple elm modules in the elm instance\n  passed to ${libName}#wrap\n\n  For more information, please read ${link('opts')}\n  `,\n\n  missingPort (name: string) {\n    return `\n    ${libName}: Unable to find a port for ${name}\n\n    Maybe you passed in a function for an incoming port,\n    or an object/primitive for an outgoing port?\n\n    For more information, please read:\n\n    ${link('usage')}\n\n    It's also possible an unforseen prop is being passed\n    into the elm component. You can read more here:\n\n    ${link('common-pitfalls')}\n    `\n  },\n\n  invalidProps: `\n  ${libName}: Elm components expect props to be an object\n  `,\n\n  invalidOpts: `\n  The provided opts to ${libName}#wrap did not match what we expected.\n\n  Please provide opts in the following format:\n\n  ${common.expectedOpt}\n  `,\n}\n\nexport default errors\n","import * as React from 'react'\n\nimport errors from './errors'\n\n/* ----------------- Types ----------------- */\n\ninterface Elm {\n  Elm: ElmStep\n}\n\ninterface ElmStep {\n  [key: string]: ElmStep | ElmModule | undefined\n}\n\ninterface ElmModule {\n  init (args: ElmInitArgs): App\n}\n\ninterface Options {\n  /** the name of the elm module, shouldn't be necessary */\n  path?: string[]\n}\n\ninterface App {\n  ports: {\n    [key: string]: {\n      subscribe? (fn: (data: any) => void): void\n      unsubscribe? (fn: (data: any) => void): void\n      send? (data: any): void\n    }\n  }\n}\n\ninterface ElmInitArgs {\n  node: HTMLDivElement,\n  flags: Object\n}\n\ntype Listener = (...data: any[]) => void\n\ninterface Listeners {\n  [key: string]: Listener\n}\n\ninterface Instance {\n  app: App\n  listeners: Listeners\n  timing: number\n}\n\ntype AddListener = (name: string, listener: Listener) => void\n\ntype SendData = (name: string, payload: any) => void\n\ntype Clean = (currentProps: string[]) => void\n\ninterface Closure {\n  sendData: AddListener\n  addListener: SendData\n  clean: Clean\n}\n\ntype Instances = Instance[]\n\n/* -------------- Type Guards -------------- */\n\nfunction isObject (test: any) : test is object {\n  if (isUndefinedOrNull(test)) { return false }\n  if (typeof test === 'function') return false\n  if (typeof test !== 'object') return false\n  return true\n}\n\nfunction isElmStep (test: any, key?: string): test is ElmStep {\n  if (isUndefinedOrNull(test)) { return false }\n  if (typeof test !== 'object') { return false }\n  if (key === '') { return false }\n  if (key) {\n    const value = test[key]\n    return isElmStep(value) || isElmModule(value)\n  }\n  if (!Object.keys(test).length) { return false }\n  return true\n}\n\nfunction isElm (test: any): test is Elm {\n  if (isUndefinedOrNull(test)) { return false }\n  if (typeof test !== 'object') { return false }\n  if (test.Elm === null) { return false }\n  if (typeof test.Elm !== 'object') { return false }\n  return true\n}\n\nfunction isElmModule (test: ElmModule | ElmStep): test is ElmModule {\n  if (isUndefinedOrNull(test)) { return false }\n  if (typeof test !== 'object') { return false }\n  if (typeof test.init !== 'function') { return false }\n  return true\n}\n\nfunction isTruthyString (test: any): test is string {\n  return (typeof test === 'string') && !!test.length\n}\n\nfunction isUndefinedOrNull (test: any): test is null | undefined {\n  return (test === null || typeof test === 'undefined')\n}\n\nfunction isOptions (options: Options) {\n  if (isUndefinedOrNull(options)) { return false }\n  if (typeof options !== 'object') { return false }\n  const { path } = options\n  if (!(isUndefinedOrNull(path) || (Array.isArray(path) && path.every(isTruthyString)))) {\n    return false\n  }\n  return true\n}\n\n/* ----------------- State ----------------- */\n\nconst {\n  getClosure,\n  createInstance,\n  hasInstance,\n  getId,\n  teardown,\n} = (() => {\n  let currentId = 1\n  const instances: Instances = []\n\n  function createClosure ({ listeners, app }: Instance): Closure {\n    return {\n      sendData (name: string, payload: any) {\n        if (app.ports[name]) {\n          if (listeners[name]) {\n            // we know this exists, because it was subscribed\n            app.ports[name].unsubscribe!(listeners[name])\n            delete listeners[name]\n          }\n          if (app.ports[name]?.send) {\n            // we just proved this exists\n            app.ports[name].send!(payload)\n          } else {\n            console.warn(errors.missingPort(name))\n          }\n        }\n      },\n      addListener (name: string, listener: Listener) {\n        if (!app.ports[name]?.subscribe) {\n          console.warn(errors.missingPort(name))\n        } else if (listeners[name] === listener) {\n          // noop (same listener, don't resubscribe)\n        } else {\n          if (listeners[name]) {\n            // we know this exists because it was subscribed\n            app.ports[name].unsubscribe!(listeners[name])\n          }\n          // we know this exists because we did type check above\n          app.ports[name].subscribe!(listener)\n          listeners[name] = listener\n        }\n      },\n      clean (currentProps: string[]) {\n        Object.keys(listeners).forEach(name => {\n          if (!currentProps.includes(name)) {\n            // we know this exists because we subscribed\n            app.ports[name].unsubscribe!(listeners[name])\n            delete listeners[name]\n          }\n        })\n      },\n    }\n  }\n\n  return {\n    getClosure (key: number) {\n      return createClosure(instances[key])\n    },\n    createInstance (key: number, app: App) {\n      if (instances[key]) {\n        throw new Error(errors.duplicateInstance)\n      }\n      const instance = {\n        app,\n        listeners: {},\n        subscriptions: [],\n        timing: 5,\n      }\n      instances[key] = instance\n\n      return instance\n    },\n    hasInstance (key: number) {\n      return !!instances[key]\n    },\n    getId () {\n      return ++currentId\n    },\n    teardown (id: number) {\n      const { listeners, app } = instances[id]\n      Object.keys(listeners).forEach(name => {\n        // we know this exists because it was subscribed\n        app.ports[name].unsubscribe!(listeners[name])\n      })\n    },\n  }\n})()\n\n/* -------------- Utilities -------------- */\n\nfunction getOnlyValue (obj: ElmStep): ElmStep | ElmModule | false {\n  const values = Object.values(obj)\n  if (values.length > 1) { return false }\n  if (values.length < 1) { return false }\n  return values[0] || false\n}\n\nfunction getOnlyModule (step: ElmStep | ElmModule): ElmModule | false {\n  if (isElmModule(step)) { return step }\n  const deeper = getOnlyValue(step)\n  if (!deeper) { return false }\n  // wouldn't tail call optimization be nice :P\n  return getOnlyModule(deeper)\n}\n\nfunction resolvePath (path: string[] = [], step: ElmStep): false | ElmModule {\n  const resolve = (path: string[], step: ElmStep | ElmModule): false | ElmModule => {\n    if (path.length === 0 && isElmModule(step)) {\n      return step\n    }\n    if (path.length === 0 || typeof step === 'undefined') {\n      return false\n    }\n    const [key, ...rest] = path\n    if (!isElmStep(step, key)) {\n      return false\n    }\n    return resolve(rest, (step[key] as ElmModule | ElmStep))\n  }\n  return resolve(path, step)\n}\n\n/* -------------- Implementation -------------- */\n\nfunction wrap <Props extends {} = {}> (elm: Elm, opts: Options = {}) {\n  if (!isElm(elm)) {\n    throw new Error(errors.invalidElmInstance)\n  }\n\n  if (!isUndefinedOrNull(opts) && !isOptions(opts)) {\n    throw new Error(errors.invalidOpts)\n  }\n\n  return function (props: Props) {\n    if (!isObject(props)) {\n      throw new Error(errors.invalidProps)\n    }\n\n    const [id] = React.useState(getId())\n    const node = React.useRef<HTMLDivElement>(null)\n\n    // mount & cleanup\n    React.useEffect(() => {\n      if (!node.current) {\n        return\n      }\n      // should only run once, setup instance\n      const consumed = document.createElement('div')\n      node.current.appendChild(consumed)\n\n      const elmModule = (() => {\n        if (opts.path?.length) {\n          const resolved = resolvePath(opts.path, elm.Elm)\n          if (resolved) { return resolved }\n          throw new Error(errors.invalidPath)\n        }\n        const resolved = getOnlyModule(elm.Elm)\n        if (resolved) { return resolved }\n        throw new Error(errors.pathRequired)\n      })()\n\n      const app = elmModule.init({\n        node: consumed,\n        flags: (() => {\n          let flags = {}\n          for (const prop in props) {\n            if (typeof (props as any)[prop] !== 'function') { (flags as any)[prop] = (props as any)[prop] }\n          }\n          return flags\n        })(),\n      })\n\n      createInstance(id, app)\n\n      return () => teardown(id)\n    }, [node])\n\n    // on update\n    React.useEffect(() => {\n      if (hasInstance(id)) {\n        const { addListener, sendData, clean } = getClosure(id)\n        const propKeys = Object.keys(props)\n        propKeys\n          .filter(key => typeof (props as any)[key] !== 'function')\n          .forEach(key => sendData(key, (props as any)[key]))\n\n        propKeys\n          .filter(key => typeof (props as any)[key] === 'function')\n          .forEach(key => addListener(key, (props as any)[key]))\n\n        clean(propKeys)\n      } else {\n        console.error(errors.missingInstance)\n      }\n    })\n\n    return <div ref={node} />\n  }\n}\n\nexport {\n  Elm,\n  ElmStep,\n  ElmModule,\n  App,\n  ElmInitArgs,\n}\n\nexport default wrap\n"],"names":["libName","link","anchor","common","code","errors","missingRef","duplicateInstance","missingInstance","missingPath","invalidElmInstance","invalidPath","pathRequired","missingPort","name","invalidProps","invalidOpts","isElmModule","test","isUndefinedOrNull","init","isTruthyString","length","currentId","instances","getClosure","key","listeners","app","sendData","payload","ports","unsubscribe","_app$ports$name","send","console","warn","addListener","listener","_app$ports$name2","subscribe","clean","currentProps","Object","keys","forEach","includes","createInstance","Error","instance","subscriptions","timing","hasInstance","getId","teardown","id","elm","opts","Elm","options","path","Array","isArray","every","isOptions","props","isObject","React","node","current","consumed","document","createElement","appendChild","_opts$path","resolved","resolve","step","rest","isElmStep","value","getOnlyModule","values","deeper","flags","prop","propKeys","filter","error","ref"],"mappings":"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"}